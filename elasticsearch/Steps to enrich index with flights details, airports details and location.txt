For this enrichment, you need to upload an index containing the airports location

#creation of enrich APIs

## match companies icao24 -> to flights icao 24
## match airports icao -> to flights estDepartureAirport
## match airports icao -> to flights estArrivalAirport
## match airports_location icao -> to flights estDepartureAirport
## match airports_location icao -> to flights estArrivalAirport

## 7 steps
### step0: upload the airports location in a new index named airports_location (csv files would provided for this purpose) with the CSV INTEGRATION of Kibana.
### step1: create 3 enrich policies
### step2: execute the policies
### step3: configure 3 pipelines
### step4: apply enrichments with reindex APIs
### step5: create an index with
### step6: delete pipelines, policies and transitional indexes
### step1: create 3 enrich policies

### step1: create 3 enrich policies
PUT /_enrich/policy/icao24-policy
{
  "match": {
    "indices": "companies",
    "match_field": "icao24",
    "enrich_fields": ["ownername", "manufacturername", "model","icao24"]
  }
}
PUT /_enrich/policy/icao-policy
{
  "match": {
    "indices": "airports",
    "match_field": "icao",
    "enrich_fields": ["ville", "nom", "taille","pays"]
  }
}
PUT /_enrich/policy/location-policy
{
  "match": {
    "indices": "airports_location",
    "match_field": "ICAO",
    "enrich_fields": ["location"]
  }
}


### step2: execute the policies 
POST /_enrich/policy/icao24-policy/_execute
POST /_enrich/policy/icao-policy/_execute
POST /_enrich/policy/location-policy/_execute



### step3: configure 5 pipelines
#configure icao24_lookup pipeline to match companies icao24 with to flights icao 24
#to change icao24 to [aircraft with enriched fields]
#to remove unrelevant fields
PUT /_ingest/pipeline/icao24_lookup
{
  "description" : "Enriching flights details with companies data",
  "processors" : [
    {
      "enrich" : {
        "policy_name": "icao24-policy",
        "field" : "icao24",
        "target_field": "aircraft",
        "max_matches": "1"
      }
    },
    {
      "remove": {
        "field": ["icao24","estDepartureAirportHorizDistance", "estDepartureAirportVertDistance", "estArrivalAirportHorizDistance", "estArrivalAirportVertDistance", "departureAirportCandidatesCount", "arrivalAirportCandidatesCount"]
      }
    }
  ]
}

#configure icao_departure_lookup pipeline to match airports icao with to flights estDepartureAirport
# add [DepartureAirport with enriched fields]
PUT /_ingest/pipeline/icao_departure_lookup
{
  "description" : "Enriching flights details with departure airports data",
  "processors" : [
    {
      "enrich" : {
        "policy_name": "icao-policy",
        "field" : "estDepartureAirport",
        "target_field": "DepartureAirport",
        "max_matches": "1"
      }
    }
  ]
}

#configure icao_arrival_lookup pipeline to match airports icao with to flights estArrivalAirport
#to change estArrivalAirport to [ArrivalAirport with enriched fields]
PUT /_ingest/pipeline/icao_arrival_lookup
{
  "description" : "Enriching flights details with arrival airports data",
  "processors" : [
    {
      "enrich" : {
        "policy_name": "icao-policy",
        "field" : "estArrivalAirport",
        "target_field": "ArrivalAirport",
        "max_matches": "1"
      }
    }
  ]
}

#configure departure_location_lookup pipeline to match airports icao with to flights estDepartureAirport
#add location
PUT /_ingest/pipeline/location_departure_lookup
{
  "description" : "Enriching departure airports with location",
  "processors" : [
    {
      "enrich" : {
        "policy_name": "location-policy",
        "field" : "estDepartureAirport",
        "target_field": "DepartureLocation",
        "max_matches": "1"
      }
    },
    {
      "remove": {
        "field": ["estDepartureAirport"]
      }
    }
  ]
}

#configure arrival_location_lookup pipeline to match airports icao with to flights estDepartureAirport
#add location
PUT /_ingest/pipeline/location_arrival_lookup
{
  "description" : "Enriching arrival airports with location",
  "processors" : [
    {
      "enrich" : {
        "policy_name": "location-policy",
        "field" : "estArrivalAirport",
        "target_field": "ArrivalLocation",
        "max_matches": "1"
      }
    },
    {
      "remove": {
        "field": ["estArrivalAirport"]
      }
    }
  ]
}

### step4: apply enrichments with reindex APIs
POST _reindex
{
  "source": {
    "index": "flights"
  },
  "dest": {
    "index": "flights1",
    "pipeline": "icao24_lookup"
  }
}
POST _reindex
{
  "source": {
    "index": "flights1"
  },
  "dest": {
    "index": "flights2",
    "pipeline": "icao_departure_lookup"
  }
}
POST _reindex
{
  "source": {
    "index": "flights2"
  },
  "dest": {
    "index": "flights3",
    "pipeline": "icao_arrival_lookup"
  }
}

POST _reindex
{
  "source": {
    "index": "flights3"
  },
  "dest": {
    "index": "flights4",
    "pipeline": "location_departure_lookup"
  }
}

POST _reindex
{
  "source": {
    "index": "flights4"
  },
  "dest": {
    "index": "flights5",
    "pipeline": "location_arrival_lookup"
  }
}

GET /flights5/_count
GET /flights5/_mapping
GET /flights/_mapping
GET /airports_location/_mapping


#we need to reindex the data because the some fields are not in an appropriate format

### step5: create an index with the appropiate format and reindex the documents

PUT /flights_riched
{
  "settings": {
    "number_of_shards": 2,
    "number_of_replicas": 1
  },
  "mappings" : {
      "properties" : {
        "ArrivalAirport" : {
          "properties" : {
            "icao" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "nom" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "pays" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "taille" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "ville" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            }
          }
        },
        "ArrivalLocation" : {
          "properties" : {
            "ICAO" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "location" : {
          "type" : "geo_point"
            }
          }
        },
        "DepartureAirport" : {
          "properties" : {
            "icao" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "nom" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "pays" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "taille" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "ville" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            }
          }
        },
        "DepartureLocation" : {
          "properties" : {
            "ICAO" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "location" : {
          "type" : "geo_point"
            }
          }
        },
        "aircraft" : {
          "properties" : {
            "icao24" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "manufacturername" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "model" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            },
            "ownername" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword"
                }
              }
            }
          }
        },
        "callsign" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword"
            }
          }
        },
        "firstSeen" : {
          "type" : "date",
          "format" : "yyyy-MM-dd HH:mm:ss"
        },
        "lastSeen" : {
          "type" : "date",
          "format" : "yyyy-MM-dd HH:mm:ss"
        }
      }
    }
  }


POST _reindex
{
  "source": {
    "index": "flights5"
  },
  "dest": {
    "index": "flights_riched"
  }
}

GET /flights_riched/_search


### step6: delete policies , pipelines and transitional indexes
DELETE /_ingest/pipeline/icao24_lookup
DELETE /_ingest/pipeline/icao_departure_lookup
DELETE /_ingest/pipeline/icao_arrival_lookup
DELETE /_ingest/pipeline/location_arrival_lookup
DELETE /_ingest/pipeline/location_departure_lookup
DELETE /_enrich/policy/location-policy
DELETE /_enrich/policy/icao24-policy
DELETE /_enrich/policy/icao-policy
DELETE /flights1
DELETE /flights2
DELETE /flights3
DELETE /flights4
DELETE /flights5
#DELETE /flights_riched

